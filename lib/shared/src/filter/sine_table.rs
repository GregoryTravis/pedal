//extern crate std;
extern crate libm;

//use core::f64::consts::PI;
//use std::println;

const TABLE_SIZE: usize = 256;

//const TABLE_SIZE_F32: f32 = TABLE_SIZE as f32;
const TWO_PI: f32 = 2.0 * core::f32::consts::PI;

//const TABLE: &'static [f32] = &[0.0; TABLE_SIZE+1];
const TABLE: &'static [f32] = &[
0.0,
0.024541229,
0.049067676,
0.07356457,
0.09801714,
0.12241068,
0.14673047,
0.17096189,
0.19509032,
0.21910124,
0.24298018,
0.26671275,
0.29028466,
0.31368175,
0.33688986,
0.35989505,
0.38268343,
0.4052413,
0.42755508,
0.44961134,
0.47139674,
0.4928982,
0.51410276,
0.53499764,
0.55557024,
0.57580817,
0.5956993,
0.6152316,
0.6343933,
0.65317285,
0.671559,
0.68954057,
0.70710677,
0.7242471,
0.7409511,
0.7572088,
0.77301043,
0.7883464,
0.8032075,
0.8175848,
0.8314696,
0.8448536,
0.8577286,
0.87008697,
0.8819213,
0.8932243,
0.9039893,
0.9142098,
0.9238795,
0.9329928,
0.94154406,
0.94952816,
0.95694035,
0.96377605,
0.97003126,
0.9757021,
0.98078525,
0.98527765,
0.9891765,
0.99247956,
0.9951847,
0.99729043,
0.99879545,
0.9996988,
1.0,
0.9996988,
0.99879545,
0.99729043,
0.9951847,
0.99247956,
0.9891765,
0.98527765,
0.98078525,
0.9757021,
0.97003126,
0.96377605,
0.95694035,
0.94952816,
0.94154406,
0.9329928,
0.9238795,
0.9142098,
0.9039893,
0.8932243,
0.8819213,
0.87008697,
0.8577286,
0.8448536,
0.8314696,
0.8175848,
0.8032075,
0.7883464,
0.77301043,
0.7572088,
0.7409511,
0.7242471,
0.70710677,
0.68954057,
0.671559,
0.65317285,
0.6343933,
0.6152316,
0.5956993,
0.57580817,
0.55557024,
0.53499764,
0.51410276,
0.4928982,
0.47139674,
0.44961134,
0.42755508,
0.4052413,
0.38268343,
0.35989505,
0.33688986,
0.31368175,
0.29028466,
0.26671275,
0.24298018,
0.21910124,
0.19509032,
0.17096189,
0.14673047,
0.12241068,
0.09801714,
0.07356457,
0.049067676,
0.024541229,
1.2246469e-16,
-0.024541229,
-0.049067676,
-0.07356457,
-0.09801714,
-0.12241068,
-0.14673047,
-0.17096189,
-0.19509032,
-0.21910124,
-0.24298018,
-0.26671275,
-0.29028466,
-0.31368175,
-0.33688986,
-0.35989505,
-0.38268343,
-0.4052413,
-0.42755508,
-0.44961134,
-0.47139674,
-0.4928982,
-0.51410276,
-0.53499764,
-0.55557024,
-0.57580817,
-0.5956993,
-0.6152316,
-0.6343933,
-0.65317285,
-0.671559,
-0.68954057,
-0.70710677,
-0.7242471,
-0.7409511,
-0.7572088,
-0.77301043,
-0.7883464,
-0.8032075,
-0.8175848,
-0.8314696,
-0.8448536,
-0.8577286,
-0.87008697,
-0.8819213,
-0.8932243,
-0.9039893,
-0.9142098,
-0.9238795,
-0.9329928,
-0.94154406,
-0.94952816,
-0.95694035,
-0.96377605,
-0.97003126,
-0.9757021,
-0.98078525,
-0.98527765,
-0.9891765,
-0.99247956,
-0.9951847,
-0.99729043,
-0.99879545,
-0.9996988,
-1.0,
-0.9996988,
-0.99879545,
-0.99729043,
-0.9951847,
-0.99247956,
-0.9891765,
-0.98527765,
-0.98078525,
-0.9757021,
-0.97003126,
-0.96377605,
-0.95694035,
-0.94952816,
-0.94154406,
-0.9329928,
-0.9238795,
-0.9142098,
-0.9039893,
-0.8932243,
-0.8819213,
-0.87008697,
-0.8577286,
-0.8448536,
-0.8314696,
-0.8175848,
-0.8032075,
-0.7883464,
-0.77301043,
-0.7572088,
-0.7409511,
-0.7242471,
-0.70710677,
-0.68954057,
-0.671559,
-0.65317285,
-0.6343933,
-0.6152316,
-0.5956993,
-0.57580817,
-0.55557024,
-0.53499764,
-0.51410276,
-0.4928982,
-0.47139674,
-0.44961134,
-0.42755508,
-0.4052413,
-0.38268343,
-0.35989505,
-0.33688986,
-0.31368175,
-0.29028466,
-0.26671275,
-0.24298018,
-0.21910124,
-0.19509032,
-0.17096189,
-0.14673047,
-0.12241068,
-0.09801714,
-0.07356457,
-0.049067676,
-0.024541229,
-2.4492937e-16,
];

pub fn table_sin(x: f32) -> f32 {
//pub fn table_sin_floor_sub(x: f32) -> f32 {
    let bin_size: f32 = TWO_PI / (TABLE_SIZE as f32);
    let bin_frac = x / bin_size;
    let bin_unwrapped_f = libm::floorf(bin_frac);
    let bin_frac = bin_frac - bin_unwrapped_f;
    let bin = (bin_unwrapped_f as usize) % TABLE_SIZE;
    //let recon = (bin_unwrapped_f * (TABLE_SIZE as f32)) + bin_frac;
    let lo = TABLE[bin];
    let hi = TABLE[bin+1];
    let interp = ((1.0 - bin_frac) * lo) + (bin_frac * hi);
    //let actual = libm::sinf(x);
    //println!("{} {} {} {} {} {} {} {} {} {} {} {}", x, bin_size, bin_frac, bin_unwrapped_f, bin_frac, bin, recon, bin, lo, hi, interp, actual);
    interp
}

/*
pub fn table_sin_floor_rem_mod_wrapped(x: f32) -> f32 {
    let x_wrapped = libm::fmodf(x, TWO_PI);
    let bin_size: f32 = TWO_PI / (TABLE_SIZE as f32);
    let quo = libm::floorf(x_wrapped / bin_size);
    let rem = libm::remainderf(x_wrapped, bin_size);
    let recon = (quo * bin_size) + rem;
    let uquo = quo as usize;
    let lo = TABLE[uquo];
    let hi = TABLE[uquo+1];
    let interp = ((1.0 - rem) * lo) + (rem * hi);
    let actual = libm::sinf(x);
    //println!("{} {} {} {} {} {} {} {} {} {}", x, bin_size, quo, rem, recon, uquo, lo, hi, interp, actual);
    interp
}

pub fn table_sin_floor_rem_mod(x: f32) -> f32 {
    let bin_size: f32 = TWO_PI / (TABLE_SIZE as f32);
    let quo = libm::floorf(x / bin_size);
    let rem = libm::remainderf(x, bin_size);
    let recon = (quo * bin_size) + rem;
    let uquo = (quo as usize) % TABLE_SIZE;
    let lo = TABLE[uquo];
    let hi = TABLE[uquo+1];
    let interp = ((1.0 - rem) * lo) + (rem * hi);
    let actual = libm::sinf(x);
    //println!("{} {} {} {} {} {} {} {} {} {}", x, bin_size, quo, rem, recon, uquo, lo, hi, interp, actual);
    interp
}

pub fn otable_sin(x: f32) -> f32 {
    let x_wrapped = libm::fmodf(x, TWO_PI);
    // pi -> 0.5 -> 8
    //let (rem, quo) = libm::remquof(x_wrapped * TABLE_SIZE_F32, TABLE_SIZE_F32);
    let (mut rem, mut quo) = libm::remquof(x_wrapped, TWO_PI / TABLE_SIZE_F32);
    if rem < 0.0 && quo == TABLE_SIZE.try_into().unwrap() {
        rem = 1.0-rem;
        quo = 0;
    }
    let uquo = quo as usize;
    //println!("{}", x_wrapped / TWO_PI);
    //println!("{} {} {} {} {}", x, x_wrapped, rem, quo, uquo);
    let lo = TABLE[uquo];
    let hi = TABLE[uquo+1];
    let interp = ((1.0 - rem) * lo) + (rem * hi);
    //let actual = libm::sinf(x);
    //println!("{} {} {} {} {} {} {} {}", x, x_wrapped, rem, quo, lo, hi, interp, actual);
    interp
}
*/
